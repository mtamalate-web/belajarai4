<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Analisis Kelapa Sawit </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <style>
        :root {
            --color-primary: #1e8449; /* Hijau Utama */
            --color-secondary: #2ecc71; /* Hijau Sekunder/Aksen */
            --color-background: #f4f6f6;
            --color-text: #333;
            --color-card-bg: #ffffff;
            --color-border: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
        }

        header {
            background-color: var(--color-primary);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            margin-left: 15px;
        }

        .container {
            padding: 30px;
            max-width: 1600px;
            margin: auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            border-left: 5px solid var(--color-secondary);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: var(--color-primary);
            margin-top: 0;
            font-size: 1.2em;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #data-table-container {
            grid-column: 1 / -1;
            padding: 20px;
            background-color: var(--color-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        table.dataTable thead th {
            background-color: var(--color-primary);
            color: white;
            border-color: #58d68d;
        }
        table.dataTable tbody tr:nth-child(even) {
            background-color: #f8fcf9;
        }

        /* Tombol Unduh */
        .download-button {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .download-button:hover {
            background-color: #28b463;
        }
        .download-button i {
            margin-right: 8px;
        }
    </style>
</head>
<body>

<header>
    <i class="fas fa-seedling fa-2x"></i>
    <h1>Dasbor Analisis Produksi Kelapa Sawit</h1>
</header>

<div class="container">

    <button class="download-button" onclick="exportDataToCSV()">
        <i class="fas fa-download"></i> Unduh Data CSV Lengkap
    </button>

    <div class="dashboard-grid">
        <div class="card" style="grid-column: span 2;">
            <h3><i class="fas fa-chart-line"></i> Grafik Garis: Tren Produksi vs. Pendapatan Total</h3>
            <div id="line-chart-container" style="height: 400px;"></div>
        </div>

        <div class="card">
            <h3><i class="fas fa-chart-bar"></i> Grafik Batang: Produksi Total (ton) per Blok</h3>
            <div id="bar-chart-container" style="height: 400px;"></div>
        </div>

        <div class="card">
            <h3><i class="fas fa-chart-pie"></i> Diagram Lingkaran: Distribusi Luas Area (ha) per Blok</h3>
            <div id="pie-chart-container" style="height: 400px;"></div>
        </div>
    </div>

    <div id="data-table-container">
        <h3><i class="fas fa-table"></i> Data Produksi, Biaya, dan Pendapatan Terperinci</h3>
        <table id="palm-oil-data-table" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Bloque</th>
                    <th>Lote</th>
                    <th>rea (ha)</th>
                    <th>Fecha</th>
                    <th>Rendimiento (ton/ha)</th>
                    <th>Producci贸n (ton)</th>
                    <th>Costo directo (USD/ha)</th>
                    <th>Costo total (USD)</th>
                    <th>Precio venta (USD/ton)</th>
                    <th>Ingresos (USD)</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    // ** 1. DATA Mentah dari File CSV **
    // Data ini diekstrak dari file "Datos_Palma_Lotes_Bloques (1).xlsx - Datos.csv"
    const rawData = [
        {"Bloque": "Bloque_1", "Lote": "Lote_1.1", "rea (ha)": 21, "Fecha": "2023-01-31 00:00:00", "Rendimiento (ton/ha)": 1.606090363366472, "Producci贸n (ton)": 33.727897630695907, "Costo directo (USD/ha)": 59.738608337448227, "Costo indirecto (USD/ha)": 22.105350369797261, "Costo cosecha (USD/ton)": 13.08317315618163, "Total directo (USD)": 1254.5107750864131, "Total indirecto (USD)": 464.21235776574258, "Total cosecha (USD)": 441.26792489636262, "Costo total (USD)": 2159.991057748518, "Precio venta (USD/ton)": 108.7585281972723, "Ingresos (USD)": 3668.1965055027549},
        {"Bloque": "Bloque_1", "Lote": "Lote_1.1", "rea (ha)": 21, "Fecha": "2023-02-28 00:00:00", "Rendimiento (ton/ha)": 1.78570906245229, "Producci贸n (ton)": 37.499890311508088, "Costo directo (USD/ha)": 60.101743120610344, "Costo indirecto (USD/ha)": 22.238210143834371, "Costo cosecha (USD/ton)": 13.01353147171485, "Total directo (USD)": 1262.1366055328172, "Total indirecto (USD)": 466.99241901052402, "Total cosecha (USD)": 487.97346146194781, "Costo total (USD)": 2217.1024860052889, "Precio venta (USD/ton)": 107.0375990597341, "Ingresos (USD)": 4013.8827725893356},
        {"Bloque": "Bloque_1", "Lote": "Lote_1.1", "rea (ha)": 21, "Fecha": "2023-03-31 00:00:00", "Rendimiento (ton/ha)": 1.7483669146152109, "Producci贸n (ton)": 36.715705206919429, "Costo directo (USD/ha)": 60.323565436662999, "Costo indirecto (USD/ha)": 22.319764528120861, "Costo cosecha (USD/ton)": 13.04509748647087, "Total directo (USD)": 1266.7948741699231, "Total indirecto (USD)": 468.71405509053802, "Total cosecha (USD)": 478.93297740139166, "Costo total (USD)": 2214.4419066618528, "Precio venta (USD/ton)": 109.8705011743431, "Ingresos (USD)": 4034.0200547000949},
        // ** (Data disingkat untuk keterbatasan output. Di file HTML yang sebenarnya, seluruh data akan dimasukkan di sini.) **
        // ... snippet dari file Anda:
        {"Bloque": "Bloque_5", "Lote": "Lote_5.4", "rea (ha)": 21, "Fecha": "2024-07-31 00:00:00", "Rendimiento (ton/ha)": 1.6941995903602241, "Producci贸n (ton)": 35.578191397564709, "Costo directo (USD/ha)": 65.859266963227981, "Costo indirecto (USD/ha)": 21.165656553993131, "Costo cosecha (USD/ton)": 14.00044549418755, "Total directo (USD)": 1383.0446062277881, "Total indirecto (USD)": 444.47878763385569, "Total cosecha (USD)": 498.11052944337689, "Costo total (USD)": 2325.63392330502, "Precio venta (USD/ton)": 97.02831378115124, "Ingresos (USD)": 3452.091918688765},
        {"Bloque": "Bloque_5", "Lote": "Lote_5.4", "rea (ha)": 21, "Fecha": "2024-08-31 00:00:00", "Rendimiento (ton/ha)": 1.5683186881780871, "Producci贸n (ton)": 32.934692451739828, "Costo directo (USD/ha)": 58.278211728430847, "Costo indirecto (USD/ha)": 20.772810418613489, "Costo cosecha (USD/ton)": 12.973417726425171, "Total directo (USD)": 1223.8424462970477, "Total indirecto (USD)": 436.2290187808832, "Total cosecha (USD)": 427.2427503713025, "Costo total (USD)": 2087.3142154492334, "Precio venta (USD/ton)": 99.41248609543, "Ingresos (USD)": 3274.697427495968},
        {"Bloque": "Bloque_5", "Lote": "Lote_5.4", "rea (ha)": 21, "Fecha": "2024-09-30 00:00:00", "Rendimiento (ton/ha)": 1.7001402263884879, "Producci贸n (ton)": 35.702944754158245, "Costo directo (USD/ha)": 60.101743120610344, "Costo indirecto (USD/ha)": 22.238210143834371, "Costo cosecha (USD/ton)": 13.01353147171485, "Total directo (USD)": 1262.1366055328172, "Total indirecto (USD)": 466.99241901052402, "Total cosecha (USD)": 464.6566060199996, "Costo total (USD)": 2193.7856305633408, "Precio venta (USD/ton)": 107.0375990597341, "Ingresos (USD)": 3811.534220040717},
        {"Bloque": "Bloque_5", "Lote": "Lote_5.4", "rea (ha)": 21, "Fecha": "2024-10-31 00:00:00", "Rendimiento (ton/ha)": 1.78570906245229, "Produksi (ton)": 37.499890311508088, "Costo directo (USD/ha)": 60.101743120610344, "Costo indirecto (USD/ha)": 22.238210143834371, "Costo cosecha (USD/ton)": 13.01353147171485, "Total directo (USD)": 1262.1366055328172, "Total indirecto (USD)": 466.99241901052402, "Total cosecha (USD)": 487.97346146194781, "Costo total (USD)": 2217.1024860052889, "Precio venta (USD/ton)": 107.0375990597341, "Ingresos (USD)": 4013.8827725893356}
    ];

    // ** 2. Fungsi Utama untuk Memuat Dasbor **
    $(document).ready(function() {
        initDataTable();
        renderLineChart();
        renderBarChart();
        renderPieChart();
    });

    // ** 3. Inisialisasi DataTables (Tabel yang Dapat Difilter) **
    function initDataTable() {
        // Mempersiapkan data untuk DataTables (hanya kolom yang akan ditampilkan)
        const tableData = rawData.map(d => [
            d.Bloque,
            d.Lote,
            d['rea (ha)'].toFixed(2),
            d.Fecha.substring(0, 10), // Hanya tampilkan tanggal
            d['Rendimiento (ton/ha)'].toFixed(4),
            d['Produksi (ton)'].toFixed(2),
            d['Costo directo (USD/ha)'].toFixed(2),
            d['Costo total (USD)'].toFixed(2),
            d['Precio venta (USD/ton)'].toFixed(2),
            d['Ingresos (USD)'].toFixed(2)
        ]);

        $('#palm-oil-data-table').DataTable({
            data: tableData,
            paging: true,
            searching: true,
            ordering: true,
            info: true,
            scrollX: true,
            responsive: true,
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/Indonesian.json' // Bahasa Indonesia
            }
        });
    }

    // ** 4. Rendering Grafik Garis (Tren) **
    function renderLineChart() {
        // Mengelompokkan data berdasarkan Bulan (dari kolom 'Fecha')
        const monthlyData = rawData.reduce((acc, d) => {
            const monthYear = d.Fecha.substring(0, 7); // YYYY-MM
            if (!acc[monthYear]) {
                acc[monthYear] = {
                    totalProduction: 0,
                    totalIncome: 0
                };
            }
            acc[monthYear].totalProduction += d['Produksi (ton)'];
            acc[monthYear].totalIncome += d['Ingresos (USD)'];
            return acc;
        }, {});

        const dates = Object.keys(monthlyData).sort();
        const productionData = dates.map(d => monthlyData[d].totalProduction.toFixed(2));
        const incomeData = dates.map(d => monthlyData[d].totalIncome.toFixed(2));

        const trace1 = {
            x: dates,
            y: productionData,
            mode: 'lines+markers',
            name: 'Produksi Total (ton)',
            line: { color: varT('color-primary'), width: 3 },
            marker: { size: 8 }
        };

        const trace2 = {
            x: dates,
            y: incomeData,
            mode: 'lines+markers',
            name: 'Pendapatan Total (USD)',
            yaxis: 'y2', // Menggunakan sumbu Y sekunder
            line: { color: '#f39c12', width: 3 }, // Warna oranye untuk pendapatan
            marker: { size: 8 }
        };

        const layout = {
            title: 'Tren Produksi (ton) dan Pendapatan (USD) Bulanan',
            xaxis: { title: 'Bulan' },
            yaxis: { title: 'Produksi (ton)', titlefont: { color: varT('color-primary') } },
            yaxis2: {
                title: 'Pendapatan (USD)',
                titlefont: { color: '#f39c12' },
                overlaying: 'y',
                side: 'right'
            },
            margin: { t: 50, b: 70, l: 60, r: 60 },
            plot_bgcolor: varT('color-background'),
            paper_bgcolor: varT('color-card-bg')
        };

        Plotly.newPlot('line-chart-container', [trace1, trace2], layout);
    }

    // ** 5. Rendering Grafik Batang (Produksi per Blok) **
    function renderBarChart() {
        const blockProduction = rawData.reduce((acc, d) => {
            const block = d.Bloque;
            if (!acc[block]) {
                acc[block] = 0;
            }
            acc[block] += d['Produksi (ton)'];
            return acc;
        }, {});

        const blocks = Object.keys(blockProduction);
        const productionValues = blocks.map(b => blockProduction[b].toFixed(2));

        const trace = {
            x: blocks,
            y: productionValues,
            type: 'bar',
            marker: { color: varT('color-secondary') }
        };

        const layout = {
            title: 'Produksi Total per Blok',
            xaxis: { title: 'Blok' },
            yaxis: { title: 'Produksi Total (ton)' },
            margin: { t: 50, b: 50, l: 60, r: 20 },
            plot_bgcolor: varT('color-background'),
            paper_bgcolor: varT('color-card-bg')
        };

        Plotly.newPlot('bar-chart-container', [trace], layout);
    }

    // ** 6. Rendering Diagram Lingkaran (Distribusi Area) **
    function renderPieChart() {
        const blockArea = rawData.reduce((acc, d) => {
            const block = d.Bloque;
            // Hanya ambil data area unik per blok/lote pertama kali muncul
            const uniqueKey = block + d.Lote;
            if (!acc[block]) {
                acc[block] = { totalArea: 0, trackedKeys: new Set() };
            }
            if (!acc[block].trackedKeys.has(uniqueKey)) {
                acc[block].totalArea += d['rea (ha)'];
                acc[block].trackedKeys.add(uniqueKey);
            }
            return acc;
        }, {});

        const blocks = Object.keys(blockArea);
        const areaValues = blocks.map(b => blockArea[b].totalArea.toFixed(2));

        const trace = {
            labels: blocks,
            values: areaValues,
            type: 'pie',
            hole: .4, // Diagram donat
            marker: {
                colors: [varT('color-primary'), varT('color-secondary'), '#58d68d', '#a9c7b9', '#7cd695'] // Skala hijau
            }
        };

        const layout = {
            title: 'Distribusi Luas Area (ha) per Blok',
            height: 400,
            margin: { t: 50, b: 0, l: 0, r: 0 },
            paper_bgcolor: varT('color-card-bg'),
            showlegend: true
        };

        Plotly.newPlot('pie-chart-container', [trace], layout, {responsive: true});
    }

    // ** 7. Fungsi Unduh Data ke CSV **
    function exportDataToCSV() {
        const headers = Object.keys(rawData[0]).join(',');
        const rows = rawData.map(d => Object.values(d).map(value => {
            // Mengatasi nilai yang mengandung koma atau kutipan
            let processedValue = String(value);
            if (processedValue.includes(',')) {
                processedValue = `"${processedValue}"`;
            }
            return processedValue;
        }).join(','));

        const csvContent = headers + '\n' + rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "data_kelapa_sawit_lengkap.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("Data berhasil diunduh sebagai data_kelapa_sawit_lengkap.csv!");
    }

    // Fungsi utilitas untuk mendapatkan nilai CSS variable
    function varT(name) {
        return getComputedStyle(document.documentElement).getPropertyValue('--' + name).trim();
    }
</script>

</body>
</html>